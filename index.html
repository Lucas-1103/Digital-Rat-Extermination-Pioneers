<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‡è€…çš„æ•¸å­¸å¤§å†’éšª</title>
    <style>
        /* åŸºç¤å…¨åŸŸè¨­å®šèˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆ */
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Arial', sans-serif;
            background-color: #fdf6e3;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .game-container {
            background: #fff;
            max-width: 600px;
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
            border: 4px solid #8e44ad;
        }
        h1 {
            color: #8e44ad;
            margin-top: 0;
        }
        /* èªéŸ³æ§åˆ¶å€å¡Š */
        .tts-controls {
            background: #f1f2f6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .tts-controls button {
            background: #e67e22;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .tts-controls button:hover { background: #d35400; }
        input[type="range"] { vertical-align: middle; }
        
        /* æ•…äº‹æ–‡å­—å€å¡Š */
        #story-text {
            font-size: 20px;
            line-height: 1.6;
            margin-bottom: 30px;
            min-height: 80px;
            padding: 15px;
            background: #e8f8f5;
            border-radius: 10px;
            border-left: 5px solid #1abc9c;
            text-align: left;
        }
        /* é¸é …æŒ‰éˆ•å€å¡Š */
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .choice-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .choice-btn:hover { background: #2980b9; }
        
        /* éª°å­ç‰¹æ•ˆ */
        #dice-display {
            font-size: 60px;
            margin: 10px 0;
            animation: bounce 0.5s ease;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
    </style>
</head>
<body>

<div class="game-container">
    <h1>âš”ï¸ å‹‡è€…çš„æ•¸å­¸å¤§å†’éšª</h1>
    
    <div class="tts-controls">
        <label for="rate">ğŸ—£ï¸ èªé€Ÿ: <span id="rate-value">1.0</span></label>
        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1">
        <button id="read-btn">ğŸ”Š æœ—è®€æ•…äº‹èˆ‡é¡Œç›®</button>
    </div>

    <div id="story-text">æ•…äº‹è¼‰å…¥ä¸­...</div>
    <div id="dice-display" style="display: none;">ğŸ²</div>
    <div class="choices-container" id="choices-box"></div>
</div>

<script>
    // === Web Speech API (TTS èªéŸ³åŠŸèƒ½) ===
    const synth = window.speechSynthesis;
    const rateInput = document.getElementById('rate');
    const rateValue = document.getElementById('rate-value');
    const readBtn = document.getElementById('read-btn');
    let currentTextToRead = "";

    // æ›´æ–°èªé€Ÿé¡¯ç¤º
    rateInput.addEventListener('input', () => {
        rateValue.textContent = rateInput.value;
    });

    // æœ—è®€æŒ‰éˆ•äº‹ä»¶
    readBtn.addEventListener('click', () => {
        if (synth.speaking) {
            synth.cancel(); // å¦‚æœæ­£åœ¨å”¸ï¼Œå…ˆåœæ­¢
        }
        if (currentTextToRead !== "") {
            const utterance = new SpeechSynthesisUtterance(currentTextToRead);
            utterance.lang = 'zh-TW'; // è¨­å®šèªè¨€ç‚ºç¹é«”ä¸­æ–‡
            utterance.rate = parseFloat(rateInput.value); // è¨­å®šèªé€Ÿ
            synth.speak(utterance);
        }
    });

    // === éŠæˆ²é‚è¼¯èˆ‡ç¯€é»è³‡æ–™ ===
    const storyTextElement = document.getElementById('story-text');
    const choicesBox = document.getElementById('choices-box');
    const diceDisplay = document.getElementById('dice-display');

    // åŠ‡æœ¬è³‡æ–™ (ä½¿ç”¨ç‰©ä»¶å„²å­˜å„å€‹é—œå¡)
    const storyNodes = {
        start: {
            text: "æ­¡è¿ä¾†åˆ°æ•¸å­¸ç‹åœ‹ï¼ä½ æ˜¯ä¸€åå‹‡æ•¢çš„é¨å£«ã€‚åœ‹ç‹è¢«é‚ªæƒ¡çš„ã€ç®—è¡“é­”ç‹ã€æŠ“èµ°äº†ã€‚ä½ èµ°é€²æ£®æ—ï¼Œé‡åˆ°äº†ä¸€éš»å²èŠå§†æ“‹ä½å»è·¯ã€‚å²èŠå§†èªªï¼šã€æˆ‘æœ‰ 8 å€‹åˆ†èº«ï¼Œæ¯å€‹åˆ†èº«å¸¶äº† 7 é¡†è˜‹æœï¼Œæˆ‘å€‘ç¸½å…±æœ‰å¹¾é¡†è˜‹æœï¼Ÿã€",
            choices: [
                { text: "56 é¡†", next: "level2" }, // 8 * 7 = 56
                { text: "54 é¡†", next: "wrong1" },
                { text: "42 é¡†", next: "wrong1" }
            ]
        },
        wrong1: {
            text: "å²èŠå§†æ–æ–é ­èªªï¼šã€ç­”éŒ¯å›‰ï¼8 ä¹˜ä»¥ 7 ç­‰æ–¼ 56ã€‚ã€å²èŠå§†æŠŠä½ å½ˆå›äº†èµ·é»ï¼Œè«‹å†è©¦ä¸€æ¬¡å§ï¼",
            choices: [
                { text: "é‡æ–°é–‹å§‹", next: "start" }
            ]
        },
        level2: {
            text: "ã€ç­”å°äº†ï¼ã€å²èŠå§†è®“é–‹äº†è·¯ã€‚ä½ ç¹¼çºŒå¾€å‰èµ°ï¼Œä¾†åˆ°äº†ä¸€æ‰‡å·¨å¤§çš„çŸ³é–€å‰ã€‚çŸ³é–€ä¸Šçš„å®ˆè¡›ç²¾éˆæ‹¿å‡ºä¸€é¡†é­”æ³•éª°å­å°ä½ èªªï¼šã€å‹‡è€…ï¼Œè«‹æ“²éª°å­ä¾†æ±ºå®šä½ çš„è€ƒé©—ï¼ã€",
            isDiceLevel: true // æ¨™è¨˜æ­¤é—œå¡éœ€è¦æ“²éª°å­
        },
        wrong2: {
            text: "ç²¾éˆå˜†äº†å£æ°£ï¼šã€ç®—éŒ¯äº†å–”ï¼Œè«‹ä½ é‡æ–°å†·éœä¸€ä¸‹å†æŒ‘æˆ°å§ã€‚ã€",
            choices: [
                { text: "é‡æ–°æŒ‘æˆ°çŸ³é–€", next: "level2" }
            ]
        },
        level3: {
            text: "çŸ³é–€è½Ÿéš†éš†åœ°æ‰“é–‹äº†ï¼ä½ ä¾†åˆ°äº†é­”ç‹çš„æˆ¿é–“ã€‚é­”ç‹èªªï¼šã€æƒ³æ•‘åœ‹ç‹å—ï¼Ÿæˆ‘é€™è£¡æœ‰ 65 é¡†é­”æ³•å¯¶çŸ³ï¼Œæˆ‘è¦æŠŠå®ƒå€‘å¹³åˆ†è£é€² 8 å€‹ç®±å­è£¡ã€‚è«‹å•æ¯å€‹ç®±å­å¯ä»¥è£å¹¾é¡†ï¼Ÿé‚„å‰©ä¸‹å¹¾é¡†è£ä¸é€²å»ï¼Ÿã€",
            choices: [
                { text: "è£ 7 é¡†ï¼Œå‰©ä¸‹ 9 é¡†", next: "wrong3" },
                { text: "è£ 8 é¡†ï¼Œå‰©ä¸‹ 1 é¡†", next: "victory" }, // 65 / 8 = 8...1
                { text: "è£ 8 é¡†ï¼Œå‰©ä¸‹ 2 é¡†", next: "wrong3" }
            ]
        },
        wrong3: {
            text: "é­”ç‹å¤§ç¬‘ï¼šã€å“ˆå“ˆå“ˆï¼é€£é™¤æ³•å’Œé¤˜æ•¸éƒ½ç®—ä¸å¥½ï¼Œå›å»é‡æ–°ä¿®ç·´å§ï¼(æç¤º: 8 ä¹˜ä»¥ 8 æ˜¯ 64)ã€",
            choices: [
                { text: "é‡æ–°æŒ‘æˆ°é­”ç‹", next: "level3" }
            ]
        },
        victory: {
            text: "é­”ç‹é©šè¨åœ°èªªï¼šã€ç«Ÿç„¶ç®—å°äº†ï¼ä½ çœŸçš„æ˜¯æ•¸å­¸å¤©æ‰ï¼ã€é­”ç‹éµå®ˆæ‰¿è«¾æ”¾äº†åœ‹ç‹ï¼Œä½ æˆç‚ºäº†æ•¸å­¸ç‹åœ‹çš„è¶…ç´šè‹±é›„ï¼æ­å–œç ´é—œï¼",
            choices: [
                { text: "å†ç©ä¸€æ¬¡", next: "start" }
            ]
        }
    };

    // æ¸²æŸ“éŠæˆ²ç¯€é»
    function renderNode(nodeId) {
        synth.cancel(); // åˆ‡æ›ç•«é¢æ™‚åœæ­¢å‰ä¸€æ¬¡çš„èªéŸ³
        diceDisplay.style.display = 'none'; // éš±è—éª°å­
        choicesBox.innerHTML = ''; // æ¸…ç©ºæŒ‰éˆ•

        const node = storyNodes[nodeId];
        
        // è™•ç†ç‰¹æ®Šéª°å­é—œå¡
        if (node.isDiceLevel) {
            currentTextToRead = node.text;
            storyTextElement.innerHTML = node.text;
            
            const rollBtn = document.createElement('button');
            rollBtn.className = 'choice-btn';
            rollBtn.innerText = "ğŸ² é»æ“Šæ“²éª°å­";
            rollBtn.onclick = () => handleDiceRoll();
            choicesBox.appendChild(rollBtn);
            return;
        }

        // ä¸€èˆ¬é—œå¡
        currentTextToRead = node.text;
        storyTextElement.innerHTML = node.text;

        node.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = choice.text;
            btn.onclick = () => renderNode(choice.next);
            choicesBox.appendChild(btn);
        });
    }

    // è™•ç†æ“²éª°å­èˆ‡å‹•æ…‹ç”Ÿæˆé¡Œç›®çš„é‚è¼¯
    function handleDiceRoll() {
        choicesBox.innerHTML = ''; // æ¸…ç©ºæ“²éª°å­æŒ‰éˆ•
        diceDisplay.style.display = 'block';
        
        // ç”¢ç”Ÿ 1~6 çš„äº‚æ•¸
        const diceValue = Math.floor(Math.random() * 6) + 1;
        
        // éª°å­é»æ•¸å°æ‡‰çš„ Unicode ç¬¦è™Ÿ âš€âšâš‚âšƒâš„âš…
        const diceFaces = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
        diceDisplay.innerText = diceFaces[diceValue - 1];

        // å‹•æ…‹ç”Ÿæˆæ•¸å­¸é¡Œ (ä¸‰å¹´ç´šä¹˜æ³•ï¼šå¤§æ•¸å­—ä¹˜æ³•)
        const multiplier = 15;
        const correctAnswer = diceValue * multiplier;
        const dynamicText = `ä½ æ“²å‡ºäº† ${diceValue} é»ï¼ç²¾éˆèªªï¼šã€è«‹ç®—å‡º ${diceValue} ä¹˜ä»¥ ${multiplier} ç­‰æ–¼å¤šå°‘ï¼Ÿã€`;
        
        currentTextToRead = dynamicText;
        storyTextElement.innerHTML = dynamicText;

        // å»ºç«‹é¸é … (ä¸€å€‹æ­£ç¢ºï¼Œå…©å€‹éš¨æ©ŸéŒ¯èª¤)
        let options = [
            { text: `${correctAnswer}`, next: "level3" },
            { text: `${correctAnswer + 10}`, next: "wrong2" },
            { text: `${correctAnswer - 5 > 0 ? correctAnswer - 5 : correctAnswer + 5}`, next: "wrong2" }
        ];

        // æ‰“äº‚é¸é …é †åº (Fisher-Yates Shuffle)
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }

        // æ¸²æŸ“å‹•æ…‹é¸é …
        options.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = choice.text;
            btn.onclick = () => renderNode(choice.next);
            choicesBox.appendChild(btn);
        });
    }

    // éŠæˆ²åˆå§‹åŒ–
    renderNode('start');

</script>
</body>
</html>
